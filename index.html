<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Refertazione Antibiogramma MIC</title>
<link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 36 36'><rect x='2' y='2' width='32' height='32' rx='8' fill='%232d5a3d'/><text x='18' y='24' font-size='18' text-anchor='middle' fill='white'>AB</text></svg>">
<link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@300;400;500;600;700&family=Source+Serif+4:wght@400;600;700&display=swap" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.1/chart.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<link rel="stylesheet" href="css/styles.css">
</head>
<body>

<header class="app-header">
  <svg viewBox="0 0 36 36" fill="none" xmlns="http://www.w3.org/2000/svg">
    <rect x="2" y="2" width="32" height="32" rx="8" stroke="white" stroke-width="2" fill="none"/>
    <circle cx="13" cy="13" r="5" stroke="white" stroke-width="1.5" fill="none"/>
    <circle cx="23" cy="23" r="5" stroke="white" stroke-width="1.5" fill="none"/>
    <line x1="16.5" y1="16.5" x2="19.5" y2="19.5" stroke="white" stroke-width="1.5"/>
    <circle cx="13" cy="13" r="1.5" fill="white"/><circle cx="23" cy="23" r="1.5" fill="white"/>
  </svg>
  <div>
    <h1>Antibiogramma MIC</h1>
    <div class="subtitle">Refertazione esame microbiologico con interpretazione diagnostica</div>
  </div>
</header>

<div class="container">
  <div class="section-tabs">
    <button class="section-tab active" onclick="showSection('setup')">1. Configurazione</button>
    <button class="section-tab" onclick="showSection('data')">2. Antibiogramma</button>
    <button class="section-tab" onclick="showSection('results')">3. Risultati</button>
    <button class="section-tab" onclick="showSection('pdf')">4. Genera PDF</button>
    <button class="section-tab" onclick="showSection('archive')">5. Archivio</button>
  </div>

  <!-- SETUP -->
  <div id="section-setup" class="fade-in">
    <div class="card">
      <div class="card-header">
        <div class="icon" style="background:var(--primary-pale);color:var(--primary)">P</div>
        <h2>Dati Paziente</h2>
      </div>
      <div class="card-body">
        <div class="grid-4">
          <div class="form-group"><label>Cognome</label><input type="text" id="pt-cognome" placeholder="Rossi"></div>
          <div class="form-group"><label>Nome</label><input type="text" id="pt-nome" placeholder="Mario"></div>
          <div class="form-group"><label>Data di nascita</label><input type="date" id="pt-dob"></div>
          <div class="form-group"><label>Sesso</label><select id="pt-sesso"><option value="M">Maschio</option><option value="F">Femmina</option></select></div>
        </div>
        <div class="grid-4" style="margin-top:12px">
          <div class="form-group"><label>Codice Fiscale</label><input type="text" id="pt-cf" placeholder="RSSMRA80A01H501Z" style="text-transform:uppercase"></div>
          <div class="form-group"><label>Data Esame</label><input type="date" id="pt-data-esame"></div>
          <div class="form-group"><label>Medico Richiedente</label><input type="text" id="pt-medico" placeholder="Dott. ..."></div>
          <div class="form-group"><label>N. Accettazione</label><input type="text" id="pt-accettazione" placeholder="ACC-2026-001"></div>
        </div>
      </div>
    </div>

    <div class="card">
      <div class="card-header">
        <div class="icon" style="background:var(--accent-pale);color:var(--accent)">C</div>
        <h2>Tipo di Campione</h2>
      </div>
      <div class="card-body">
        <div class="preset-grid" id="preset-grid"></div>
        <!-- Custom sample label for "Altro Materiale" -->
        <div id="custom-sample-label-row" class="custom-sample-row hidden">
          <label style="font-size:12px;font-weight:600;color:var(--text-secondary);text-transform:uppercase;display:block;margin-bottom:4px">Specifica tipo di campione</label>
          <input type="text" id="custom-sample-label" placeholder="Es. Tampone auricolare, Liquido pleurico, Aspirato bronchiale..." oninput="onCustomSampleLabelChange()">
        </div>
        <!-- Custom panels management -->
        <div style="margin-top:14px;display:flex;justify-content:flex-end">
          <button class="btn btn-outline btn-sm" onclick="showCustomPanelsModal()">Gestisci Pannelli Antibiotici Personalizzati</button>
        </div>
      </div>
    </div>

    <div class="card">
      <div class="card-header">
        <div class="icon" style="background:#e8e0f0;color:#6b3fa0">M</div>
        <h2>Microrganismo Isolato</h2>
      </div>
      <div class="card-body">
        <div class="grid-3">
          <div class="form-group">
            <label>Campione</label>
            <div id="cfg-sample-label" style="font-weight:600;font-size:14px;padding:8px 0;color:var(--primary)">-- Seleziona tipo sopra --</div>
          </div>
          <div class="form-group">
            <label>Microrganismo</label>
            <select id="cfg-organism" onchange="onOrganismChange()">
              <option value="">-- Seleziona campione prima --</option>
            </select>
          </div>
          <div class="form-group">
            <label>Carica batterica</label>
            <input type="text" id="cfg-colony-count" placeholder="es. >100000 o 1e5 o 10^5" oninput="updateColonyCount()">
            <div id="colony-sci-display" class="hidden" style="margin-top:4px"></div>
          </div>
        </div>
        <div id="custom-organism-row" class="hidden" style="margin-top:12px">
          <div class="grid-2">
            <div class="form-group"><label>Nome microrganismo (manuale)</label><input type="text" id="cfg-organism-custom" placeholder="Es. Mycobacterium tuberculosis"></div>
            <div style="display:flex;align-items:flex-end"><button class="btn btn-primary btn-sm" onclick="applyCustomOrganism()">Conferma</button></div>
          </div>
        </div>
      </div>
    </div>

    <div class="actions-bar">
      <button class="btn btn-primary btn-lg" onclick="proceedToData()">Prosegui all'antibiogramma &rarr;</button>
    </div>
  </div>

  <!-- DATA ENTRY -->
  <div id="section-data" class="hidden fade-in">
    <div class="card">
      <div class="card-header">
        <div class="icon" style="background:var(--primary-pale);color:var(--primary)">AB</div>
        <h2>Antibiogramma &mdash; <span id="data-title"></span></h2>
      </div>
      <div class="card-body">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px;flex-wrap:wrap;gap:8px">
          <div id="ab-count"></div>
          <button class="btn btn-primary btn-sm" onclick="showAddAntibioticModal()">+ Aggiungi Antibiotico</button>
        </div>
        <p style="font-size:12px;color:var(--text-muted);margin-bottom:8px">Inserendo il valore MIC, la classificazione S/I/R viene compilata automaticamente in base ai breakpoint EUCAST. E possibile modificarla manualmente.</p>
        <div class="data-table-wrap">
          <table id="abg-table">
            <thead><tr><th>Antibiotico</th><th>Codice</th><th>Breakpoint EUCAST (mg/L)</th><th>MIC (ug/mL)</th><th>S/I/R</th><th>Stato</th><th></th></tr></thead>
            <tbody></tbody>
          </table>
        </div>
        <div class="divider"></div>
        <div class="form-group">
          <label>Metodica / Note Tecniche</label>
          <textarea id="methodology" class="methodology-input" placeholder="Metodica...">Identificazione: spettrometria di massa MALDI-TOF
Antibiogramma: microdiluizione in brodo (MIC) - sistema automatizzato
Breakpoints: EUCAST v15.0 (2025)
Interpretazione: S = Sensibile, I = Sensibilita intermedia (efficace a dosaggio aumentato), R = Resistente</textarea>
        </div>
      </div>
    </div>
    <div class="actions-bar">
      <button class="btn btn-outline" onclick="showSection('setup')">&larr; Configurazione</button>
      <button class="btn btn-primary btn-lg" onclick="proceedToResults()">Visualizza Risultati &rarr;</button>
    </div>
  </div>

  <!-- RESULTS -->
  <div id="section-results" class="hidden fade-in">
    <div class="card">
      <div class="card-header">
        <div class="icon" style="background:var(--success-pale);color:var(--success)">G</div>
        <h2>Profilo di Resistenza</h2>
      </div>
      <div class="card-body">
        <div class="grid-2">
          <div class="chart-container"><canvas id="resistanceChart"></canvas></div>
          <div class="bar-chart-container"><canvas id="barChart"></canvas></div>
        </div>
      </div>
    </div>
    <div class="card">
      <div class="card-header">
        <div class="icon" style="background:var(--primary-pale);color:var(--primary)">R</div>
        <h2>Riepilogo e Interpretazione</h2>
      </div>
      <div class="card-body">
        <div class="toggle-row" style="margin-bottom:16px;padding:10px 14px;background:var(--surface-alt);border-radius:8px">
          <label class="toggle-switch"><input type="checkbox" id="show-interp" checked onchange="toggleInterpretation()"><span class="toggle-slider"></span></label>
          <span style="font-weight:500">Mostra interpretazione diagnostica</span>
        </div>
        <div id="results-summary-content"></div>
      </div>
    </div>
    <div class="actions-bar">
      <button class="btn btn-outline" onclick="showSection('data')">&larr; Modifica dati</button>
      <button class="btn btn-primary btn-lg" onclick="showSection('pdf')">Prepara PDF &rarr;</button>
    </div>
  </div>

  <!-- PDF -->
  <div id="section-pdf" class="hidden fade-in">
    <div class="card">
      <div class="card-header">
        <div class="icon" style="background:var(--accent-pale);color:var(--accent)">H</div>
        <h2>Intestazione (Logo / Header)</h2>
      </div>
      <div class="card-body">
        <div class="header-upload" id="header-upload-area" onclick="document.getElementById('header-file').click()">
          <input type="file" id="header-file" accept="image/*" style="display:none" onchange="handleHeaderUpload(event)">
          <div id="upload-placeholder">
            <div style="font-size:24px;margin-bottom:8px;color:var(--text-muted)">[Carica immagine]</div>
            <div style="font-weight:500;color:var(--text-secondary)">Clicca per caricare intestazione</div>
            <div style="font-size:12px;color:var(--text-muted);margin-top:4px">JPG, PNG &mdash; 800x120 px consigliato</div>
          </div>
          <img id="header-preview" class="hidden">
        </div>
        <div style="margin-top:8px;display:flex;justify-content:space-between;align-items:center">
          <div class="toggle-row">
            <label class="toggle-switch"><input type="checkbox" id="toggle-save-settings" onchange="onSaveToggleChange()"><span class="toggle-slider"></span></label>
            <span style="font-weight:500;font-size:13px">Salva impostazioni</span>
            <span id="save-status" style="margin-left:8px"></span>
          </div>
          <button class="btn btn-outline btn-sm" id="btn-remove-header" onclick="removeHeader()" style="display:none">Rimuovi</button>
        </div>
      </div>
    </div>
    <div class="card">
      <div class="card-header">
        <div class="icon" style="background:var(--primary-pale);color:var(--primary)">PDF</div>
        <h2>Genera PDF</h2>
      </div>
      <div class="card-body">
        <div class="grid-2">
          <div class="form-group"><label>Titolo Referto</label><input type="text" id="pdf-title" value="Referto Esame Microbiologico con Antibiogramma"></div>
          <div class="form-group"><label>Note aggiuntive</label><input type="text" id="pdf-notes" placeholder="Note opzionali..."></div>
        </div>
        <div class="toggle-row" style="margin-top:12px">
          <label class="toggle-switch"><input type="checkbox" id="pdf-include-graph" checked><span class="toggle-slider"></span></label>
          <span style="font-weight:500">Includi grafico resistenza nel PDF</span>
        </div>
        <div class="toggle-row">
          <label class="toggle-switch"><input type="checkbox" id="pdf-include-interp" checked><span class="toggle-slider"></span></label>
          <span style="font-weight:500">Includi interpretazione e suggerimenti terapeutici</span>
        </div>
        <div id="lib-status" style="margin-top:12px"></div>
        <div class="actions-bar" style="justify-content:center;flex-direction:column;align-items:center;gap:12px;padding-top:24px">
          <button class="btn btn-accent btn-lg" id="btn-gen-pdf" onclick="generatePDF()">Genera PDF</button>
          <button class="btn btn-outline btn-sm" onclick="downloadHTML()">Scarica app HTML (uso offline)</button>
        </div>
        <div id="pdf-preview" class="hidden" style="margin-top:16px"></div>
      </div>
    </div>
    <div class="actions-bar"><button class="btn btn-outline" onclick="showSection('results')">&larr; Risultati</button></div>
  </div>

  <!-- ARCHIVE -->
  <div id="section-archive" class="hidden fade-in">
    <div class="card">
      <div class="card-header">
        <div class="icon" style="background:var(--primary-pale);color:var(--primary)">DB</div>
        <h2>Archivio Pazienti e Referti</h2>
      </div>
      <div class="card-body">
        <div id="archive-stats" class="db-stats"></div>
        <input type="text" class="db-search" id="archive-search" placeholder="Cerca per nome, CF, microrganismo, data..." oninput="renderArchive()">
        <div style="margin:12px 0;display:flex;gap:8px;flex-wrap:wrap">
          <button class="btn btn-outline btn-sm" onclick="exportArchive()">Esporta (JSON)</button>
          <button class="btn btn-outline btn-sm" onclick="document.getElementById('import-file').click()">Importa</button>
          <input type="file" id="import-file" accept=".json" style="display:none" onchange="importArchive(event)">
          <button class="btn btn-danger-outline btn-sm" onclick="clearArchive()">Svuota</button>
        </div>
        <div id="archive-list" class="db-list"></div>
      </div>
    </div>
    <div class="actions-bar"><button class="btn btn-primary btn-lg" onclick="showSection('setup')">&larr; Nuovo referto</button></div>
  </div>
</div>

<!-- Add Antibiotic Modal -->
<div id="add-ab-modal" class="modal-overlay hidden" onclick="if(event.target===this)hideAddAntibioticModal()">
  <div class="modal-content">
    <div class="modal-header">
      <h3>Aggiungi Antibiotico al Pannello</h3>
      <button class="modal-close" onclick="hideAddAntibioticModal()">X</button>
    </div>
    <div class="modal-body">
      <input type="text" id="ab-search" placeholder="Cerca antibiotico, classe, nome commerciale..." oninput="renderAvailableAntibiotics()">
      <div id="ab-available-list"></div>
      <div class="divider"></div>
      <h4 style="font-size:13px;font-weight:600;margin-bottom:8px">Oppure aggiungi personalizzato:</h4>
      <div class="grid-3">
        <div class="form-group"><label>Nome</label><input type="text" id="custom-ab-name" placeholder="Nome antibiotico"></div>
        <div class="form-group"><label>Nome Commerciale</label><input type="text" id="custom-ab-brand" placeholder="Brand"></div>
        <div class="form-group"><label>Classe</label><input type="text" id="custom-ab-class" placeholder="Classe"></div>
      </div>
      <div class="grid-3" style="margin-top:4px">
        <div class="form-group"><label>Codice (es. AMX, CIP)</label><input type="text" id="custom-ab-code" placeholder="Codice breve" maxlength="6" style="text-transform:uppercase"></div>
        <div class="form-group"><label>BP S &le; (mg/L)</label><input type="number" id="custom-ab-bps" placeholder="es. 8" step="any" min="0"></div>
        <div class="form-group"><label>BP R &gt; (mg/L)</label><input type="number" id="custom-ab-bpr" placeholder="es. 8" step="any" min="0"></div>
      </div>
      <button class="btn btn-primary btn-sm" style="margin-top:8px" onclick="addCustomAntibiotic()">+ Aggiungi Personalizzato</button>
    </div>
  </div>
</div>

<!-- Custom Panels Modal -->
<div id="custom-panels-modal" class="modal-overlay hidden" onclick="if(event.target===this)hideCustomPanelsModal()">
  <div class="modal-content" style="max-width:720px">
    <div class="modal-header">
      <h3>Pannelli Antibiotici Personalizzati</h3>
      <button class="modal-close" onclick="hideCustomPanelsModal()">X</button>
    </div>
    <div class="modal-body">
      <!-- LIST VIEW -->
      <div id="cp-list-section">
        <p style="font-size:13px;color:var(--text-secondary);margin-bottom:12px">Crea pannelli aggiuntivi di antibiotici e associali a uno o piu tipi di esame. Quando scegli un esame, i pannelli associati verranno aggiunti automaticamente al pannello di default.</p>
        <div id="custom-panels-list"></div>
        <div style="margin-top:14px;text-align:center">
          <button class="btn btn-primary" onclick="showNewPanelForm()">+ Nuovo Pannello</button>
        </div>
      </div>

      <!-- FORM VIEW -->
      <div id="cp-form-section" class="hidden">
        <h4 id="cp-form-title" style="font-size:15px;font-weight:700;margin-bottom:12px">Nuovo Pannello Antibiotici</h4>

        <div class="cp-form-group">
          <label>Nome del pannello</label>
          <input type="text" id="cp-panel-name" placeholder="Es. Panel MDR, Panel Gram+, ecc.">
        </div>

        <div class="cp-form-group">
          <label>Associa a questi tipi di esame</label>
          <div id="cp-exam-checkboxes" style="display:flex;flex-wrap:wrap;gap:2px"></div>
        </div>

        <div class="cp-form-group">
          <label>Seleziona antibiotici</label>
          <input type="text" id="cp-ab-search" placeholder="Cerca antibiotico..." oninput="filterPanelAntibiotics()" style="margin-bottom:6px">
          <div class="cp-btn-bar">
            <button class="btn btn-outline btn-sm" onclick="cpSelectAllAbs(true)">Seleziona tutti</button>
            <button class="btn btn-outline btn-sm" onclick="cpSelectAllAbs(false)">Deseleziona tutti</button>
          </div>
          <div id="cp-ab-checkboxes" class="cp-scrollable"></div>
        </div>

        <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:16px">
          <button class="btn btn-outline" onclick="cancelPanelForm()">Annulla</button>
          <button class="btn btn-primary" onclick="savePanelForm()">Salva Pannello</button>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Hidden canvas for PDF chart -->
<canvas id="pdfChartCanvas" style="display:none" width="440" height="440"></canvas>

<!-- JS Modules -->
<script src="js/state.js"></script>
<script src="js/presets.js"></script>
<script src="js/config.js"></script>
<script src="js/navigation.js"></script>
<script src="js/data-entry.js"></script>
<script src="js/charts.js"></script>
<script src="js/results.js"></script>
<script src="js/custom-panels.js"></script>
<script src="js/storage.js"></script>
<script src="js/database.js"></script>
<script src="js/pdf-generator.js"></script>
<script src="js/init.js"></script>
</body>
</html>
